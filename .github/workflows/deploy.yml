name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '18'

jobs:
  # ==========================================
  # Job 1: Run Tests
  # ==========================================
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-type: [unit, integration, api]
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install dependencies
      run: npm install
    
    - name: Run ${{ matrix.test-type }} tests
      run: |
        if [ "${{ matrix.test-type }}" = "unit" ]; then
          npm run test:unit -- --coverage --passWithNoTests --forceExit
        elif [ "${{ matrix.test-type }}" = "integration" ]; then
          npm run test:integration -- --coverage --passWithNoTests --forceExit
        elif [ "${{ matrix.test-type }}" = "api" ]; then
          npm run test:api:health -- --passWithNoTests --forceExit
        fi

  # ==========================================
  # Job 2: Build Docker Images
  # ==========================================
  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Backend Docker Image
      run: |
        docker build -f Dockerfile.backend -t vttless-backend:${{ github.sha }} .
        docker tag vttless-backend:${{ github.sha }} vttless-backend:latest
    
    - name: Build Client Docker Image  
      run: |
        docker build -f Dockerfile.client \
          --build-arg REACT_APP_BACKEND_BASE_URL=${{ secrets.REACT_APP_BACKEND_BASE_URL }} \
          --build-arg REACT_APP_SOCKET_URL=${{ secrets.REACT_APP_SOCKET_URL }} \
          -t vttless-client:${{ github.sha }} .
        docker tag vttless-client:${{ github.sha }} vttless-client:latest
    
    - name: Build EventServer Docker Image
      run: |
        docker build -f Dockerfile.eventserver -t vttless-eventserver:${{ github.sha }} .
        docker tag vttless-eventserver:${{ github.sha }} vttless-eventserver:latest

  # ==========================================
  # Job 3: Deploy to Railway Production
  # ==========================================
  deploy-backend:
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    needs: [test, build]
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    environment:
      name: production-backend
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy Backend to Railway
      run: railway up --service vttless-backend
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  deploy-client:
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    needs: [test, build, deploy-backend]
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    environment:
      name: production-client
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy Client to Railway
      run: railway up --service vttless-client
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  deploy-eventserver:
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    needs: [test, build, deploy-backend]
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    environment:
      name: production-eventserver
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy EventServer to Railway
      run: railway up --service vttless-eventserver
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # ==========================================
  # Job 4: Health Check
  # ==========================================
  health-check:
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-client, deploy-eventserver]
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    steps:
    - name: Wait for deployment
      run: sleep 30
    
    - name: Health Check Backend
      run: |
        curl -f ${{ secrets.BACKEND_HEALTH_URL }}/health || exit 1
    
    - name: Health Check EventServer
      run: |
        curl -f ${{ secrets.EVENTSERVER_HEALTH_URL }}/health || exit 1
    
    - name: Health Check Client
      run: |
        curl -f -s -o /dev/null -w "%{http_code}" ${{ secrets.CLIENT_URL }} | grep -q "200\\|301\\|302" || exit 1

  # ==========================================
  # Job 5: Notify on Success/Failure
  # ==========================================
  notify:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()
    steps:
    - name: Notify Test/Build Status
      run: |
        if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.build.result }}" = "success" ]; then
          echo "✅ Tests and Build successful!"
        else
          echo "❌ Tests or Build failed!"
          exit 1
        fi
